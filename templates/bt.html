<!doctype html>
<html><head><meta charset="utf-8"><title>Bluetooth</title>
<link rel="stylesheet" href="/static/style.css"></head>
<body>
<div class="container">
  <h1>Bluetooth</h1>

  <!-- Scan section -->
  <div class="card">
    <h3>Scan for Devices</h3>
    <p style="text-align:center"><button id="scan">Scan</button></p>
    <!-- List of discovered devices will be rendered here -->
    <div id="scanout" class="device-list"><em>No scan yet</em></div>
  </div>

  <!-- Previously seen devices -->
  <div class="card">
    <h3>Previously Seen</h3>
    <div class="device-list">
      {% for d in paired %}
        <div class="device-row">{{ d.name }} ({{ d.mac }})</div>
      {% endfor %}
      {% if paired|length == 0 %}
        <div class="device-row"><em>None</em></div>
      {% endif %}
    </div>
  </div>

  <p style="text-align:center"><a href="/">Back</a></p>
</div>

<script>
// Toast helper to display messages centrally
function showToast(message, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  if (isError) toast.classList.add('error'); else toast.classList.remove('error');
  toast.style.display = 'block';
  // Hide after 3 seconds
  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

// Modal for entering PIN codes
let pendingMac = '';
function showPinDialog(mac, name) {
  pendingMac = mac;
  document.getElementById('pin-device-name').textContent = name;
  document.getElementById('pin-input').value = '';
  document.getElementById('pin-modal').style.display = 'block';
}
function hidePinDialog() {
  document.getElementById('pin-modal').style.display = 'none';
}
async function connectWithPin() {
  const pinValue = document.getElementById('pin-input').value;
  const fd = new FormData();
  fd.append('mac', pendingMac);
  fd.append('save_as_preferred', 'on');
  if (pinValue) fd.append('pin', pinValue);
  try {
    const r2 = await fetch('/bt/connect_json', { method:'POST', body: fd });
    const j2 = await r2.json();
    hidePinDialog();
    if (j2.ok) {
      showToast('Connected');
    } else {
      showToast('Failed: ' + (j2.error || 'Unknown error'), true);
    }
  } catch (err) {
    hidePinDialog();
    showToast('Connection error', true);
  }
}
const out = document.getElementById('scanout');
document.getElementById('scan').onclick = async () => {
  // Show scanning status
  out.innerHTML = '<em>Scanningâ€¦</em>';
  try {
    const r = await fetch('/bt/scan_json');
    const j = await r.json();
    if(!j.ok){ out.innerHTML = '<em>Scan failed: '+(j.error||'')+'</em>'; return; }
    // Clear previous results
    out.innerHTML = '';
    if(j.devices.length === 0){
      out.innerHTML = '<em>No devices found</em>';
      return;
    }
    j.devices.forEach(d => {
      const row = document.createElement('div');
      row.classList.add('device-row');
      const btn = document.createElement('button');
      btn.textContent = 'Connect';
      btn.onclick = () => {
        showPinDialog(d.mac, d.name);
      };
      row.textContent = d.name + ' (' + d.mac + ')';
      row.appendChild(btn);
      out.appendChild(row);
    });
  } catch (err) {
    out.innerHTML = '<em>Scan error</em>';
  }
};
</script>
<!-- Modal for PIN input -->
<div id="pin-modal" class="modal">
  <h3>Enter PIN for <span id="pin-device-name"></span></h3>
  <input id="pin-input" type="text" placeholder="PIN code">
  <div class="actions">
    <button onclick="hidePinDialog()">Cancel</button>
    <button onclick="connectWithPin()">Connect</button>
  </div>
</div>
<!-- Toast notification container -->
<div id="toast" class="toast"></div>
</body>
</html>
