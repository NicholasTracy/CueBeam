<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CueBeam</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- Styles are defined in static/style.css for dark theme and responsive layout -->
</head>
<body data-msg="{{ request.query_params.get('msg','') }}">
<div id="toast" class="toast"></div>
<div class="container">
  <h1>CueBeam</h1>

  <div class="card"><h3>Now Playing</h3><div id="np">—</div></div>
  <div class="card"><h3>System</h3><div id="sys">loading…</div></div>
  <div class="card"><h3>Status</h3><div id="status">connecting…</div></div>

  <form method="post" action="/action" style="text-align:center">
    <button name="cmd" value="pause">Pause/Resume</button>
    <button name="cmd" value="skip">Skip</button>
    <button name="cmd" value="trigger_event">Trigger Event</button>
    <button name="cmd" value="trigger_random">Play Random</button>
    <button name="cmd" value="shutdown" onclick="return confirm('Shutdown Pi?')">Shutdown</button>
    <button name="cmd" value="reboot" onclick="return confirm('Reboot Pi?')">Reboot</button>
  </form>

  <h2>Upload</h2>
  <form method="post" action="/upload" enctype="multipart/form-data" style="text-align:center">
    <input type="file" name="file" required>
    <select name="target">
      <option value="idle">idle</option>
      <option value="events">events</option>
      <option value="random">random</option>
    </select>
    <button type="submit">Upload</button>
  </form>

  <!-- Upload progress bar (hidden until an upload is in progress) -->
  <div id="upload-progress" style="display:none; margin-top:0.5rem;">
    <progress id="upload-bar" value="0" max="100" style="width:100%; height:1rem;"></progress>
  </div>

  <p style="text-align:center"><a href="/settings">Settings</a> | <a href="/bt/list">Bluetooth</a> |
  <a href="/logs">Logs</a></p>
</div>

<script>
function humanUptime(s){
  s = Math.floor(s||0);
  const d = Math.floor(s/86400); s%=86400;
  const h = Math.floor(s/3600); s%=3600;
  const m = Math.floor(s/60);
  const parts=[];
  if(d) parts.push(d+'d'); if(h) parts.push(h+'h'); if(m) parts.push(m+'m');
  return parts.join(' ')||'0m';
}
const el = document.getElementById('status');
const np = document.getElementById('np');
const sys = document.getElementById('sys');

function humanLabel(key){
  return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}
function formatValue(val){
  if (Array.isArray(val)) return val.length + ' items';
  if (val && typeof val === 'object') {
    return Object.entries(val).map(([k,v]) => `${humanLabel(k)}: ${v}`).join(', ');
  }
  return String(val);
}
function renderStatus(s){
  // Update "Now Playing" label
  const name = s.current_basename || '(none)';
  const cat = s.current_category || '-';
  np.textContent = name + (cat ? '  [' + cat + ']' : '');
  // Build a human‑readable table of status entries
  const entries = Object.entries(s).map(([k,v]) => [humanLabel(k), formatValue(v)]);
  let html = '<table class="stat-table">';
  for (let i = 0; i < entries.length; i += 2) {
    const [k1, v1] = entries[i];
    const pair2 = entries[i+1] || ['', ''];
    const [k2, v2] = pair2;
    html += `<tr><th>${k1}</th><td>${v1}</td><th>${k2}</th><td>${v2}</td></tr>`;
  }
  html += '</table>';
  el.innerHTML = html;
}
function renderSysinfo(j){
  // Map system info to human‑readable entries
  const data = {
    'Host': j.hostname || '',
    'IPs': (j.ips || []).join(', '),
    'Uptime': humanUptime(j.uptime_s),
    'CPU Temp': (j.cpu_temp_c != null) ? (j.cpu_temp_c + '°C') : 'n/a'
  };
  const entries = Object.entries(data);
  let html = '<table class="stat-table">';
  for (let i = 0; i < entries.length; i += 2) {
    const [k1, v1] = entries[i];
    const pair2 = entries[i+1] || ['', ''];
    const [k2, v2] = pair2;
    html += `<tr><th>${k1}</th><td>${v1}</td><th>${k2}</th><td>${v2}</td></tr>`;
  }
  html += '</table>';
  sys.innerHTML = html;
}
function fallback(){
  fetch('/api/status').then(r=>r.json()).then(renderStatus).catch(()=>{el.textContent='status error'});
}
try {
  const ws = new WebSocket(`ws://${location.host}/ws/status`);
  ws.onmessage = (e)=>renderStatus(JSON.parse(e.data));
  ws.onerror = fallback; ws.onclose = fallback;
} catch { fallback(); }

function getSys(){ fetch('/api/sysinfo').then(r=>r.json()).then(renderSysinfo).catch(()=>{}); }
getSys(); setInterval(getSys, 5000);

const msg = document.body.dataset.msg;
if(msg){
  const t = document.getElementById('toast');
  // Determine message based on query parameter
  if(msg === 'uploaded'){
    t.textContent = 'Upload successful';
    t.classList.remove('error');
  } else if(msg === 'invalidfile'){
    t.textContent = 'Invalid file type. Please upload a supported video file.';
    t.classList.add('error');
  } else {
    t.textContent = 'Upload failed';
    t.classList.add('error');
  }
  t.style.display='block';
  setTimeout(()=>t.style.display='none', 3000);
}

// Attach progress handling to the upload form
{
  const form = document.querySelector('form[action="/upload"]');
  const progressContainer = document.getElementById('upload-progress');
  const bar = document.getElementById('upload-bar');
  if(form){
    form.addEventListener('submit', function(ev){
      // Do not interfere with default behaviour if no file selected or unsupported methods
      if(!form.file || !form.file.files || !form.file.files[0]) return;
      ev.preventDefault();
      const fd = new FormData(form);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload');
      // Show progress bar
      progressContainer.style.display = 'block';
      bar.value = 0;
      xhr.upload.addEventListener('progress', e => {
        if(e.lengthComputable){ bar.value = (e.loaded / e.total) * 100; }
      });
      xhr.onreadystatechange = () => {
        if(xhr.readyState === 4){
          // Redirect on completion to handle success or error via query parameter
          if(xhr.status >= 200 && xhr.status < 400){
            window.location.href = xhr.responseURL;
          } else {
            window.location.href = '/?msg=error';
          }
        }
      };
      xhr.send(fd);
    });
  }
}
</script>
</body>
</html>
