<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CueBeam Media</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body data-msg="{{ request.query_params.get('msg','') }}">
<div id="toast" class="toast"></div>
<div class="container">
  <h1>Media Management</h1>

  <!-- Upload form inside a card -->
  <div class="card">
    <h3>Upload Media</h3>
    <form method="post" action="/upload" enctype="multipart/form-data" style="text-align:center">
      <input type="file" name="file" required>
      <select name="target">
        <option value="idle">idle</option>
        <option value="events">events</option>
        <option value="random">random</option>
      </select>
      <button type="submit">Upload</button>
    </form>
    <!-- Upload progress bar and percentage -->
    <div id="upload-progress" style="display:none; margin-top:0.5rem; text-align:center;">
      <progress id="upload-bar" value="0" max="100" style="width:100%; height:1rem;"></progress>
      <div id="upload-percent" style="margin-top:0.3rem; font-size:0.9rem;">0%</div>
    </div>
  </div>

  <!-- File browser listing current media files -->
  <div class="card">
    <h3>Media Files</h3>
    <div>
      <h4>Idle Files</h4>
      <ul id="idle-list" class="file-list"></ul>
      <h4>Event Files</h4>
      <ul id="events-list" class="file-list"></ul>
      <h4>Random Files</h4>
      <ul id="random-list" class="file-list"></ul>
    </div>
  </div>

  <p style="text-align:center"><a href="/">Home</a> | <a href="/settings">Settings</a> | <a href="/bt/list">Bluetooth</a> | <a href="/logs">Logs</a></p>
</div>

<script>
// Toast message handling
{
  const msg = document.body.dataset.msg;
  if(msg){
    const t = document.getElementById('toast');
    if(msg === 'uploaded'){
      t.textContent = 'Upload successful';
      t.classList.remove('error');
    } else if(msg === 'invalidfile'){
      t.textContent = 'Invalid file type. Please upload a supported video file.';
      t.classList.add('error');
    } else {
      t.textContent = 'Upload failed';
      t.classList.add('error');
    }
    t.style.display='block';
    setTimeout(()=>t.style.display='none', 3000);
  }
}

// Upload progress handling with percentage
{
  const form = document.querySelector('form[action="/upload"]');
  const progressContainer = document.getElementById('upload-progress');
  const bar = document.getElementById('upload-bar');
  const pct = document.getElementById('upload-percent');
  if(form){
    form.addEventListener('submit', function(ev){
      // Do not interfere if no file selected
      if(!form.file || !form.file.files || !form.file.files[0]) return;
      ev.preventDefault();
      const fd = new FormData(form);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload');
      // Show progress bar
      progressContainer.style.display = 'block';
      bar.value = 0;
      pct.textContent = '0%';
      xhr.upload.addEventListener('progress', e => {
        if(e.lengthComputable){
          const percent = Math.round((e.loaded / e.total) * 100);
          bar.value = percent;
          pct.textContent = percent + '%';
        }
      });
      xhr.onreadystatechange = () => {
        if(xhr.readyState === 4){
          // Redirect to reflect success/error and update file list
          if(xhr.status >= 200 && xhr.status < 400){
            window.location.href = xhr.responseURL;
          } else {
            window.location.href = '/media?msg=error';
          }
        }
      };
      xhr.send(fd);
    });
  }
}

// Load and display media file lists
function loadFiles(){
  fetch('/api/media').then(r=>r.json()).then(data => {
    ['idle','events','random'].forEach(function(cat){
      const list = document.getElementById(cat + '-list');
      if(list){
        list.innerHTML = '';
        (data[cat] || []).forEach(function(name){
          const li = document.createElement('li');
          li.textContent = name;
          list.appendChild(li);
        });
        if((data[cat] || []).length === 0){
          const li = document.createElement('li');
          li.textContent = '(none)';
          li.style.color = '#666';
          list.appendChild(li);
        }
      }
    });
  }).catch(()=>{});
}
// Fetch file lists on page load and every 10 seconds
loadFiles();
setInterval(loadFiles, 10000);

</script>
</body>
</html>
